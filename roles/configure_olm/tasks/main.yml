# Copyright redhat-consulting-services Authors
# SPDX-License-Identifier: Apache-2.0
---
- name: Disable Default Operators
  kubernetes.core.k8s_json_patch:
    kubeconfig: "{{ kubeconfig_path }}"
    kind: OperatorHub
    name: cluster
    patch:
      - op: add
        path: "/spec/disableAllDefaultSources"
        value: "{{ disable_default_operator_sources | default(true) }}"
  when: manage_operator_hub | default(true)

- name: Apply Operator CatalogSources
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig_path }}"
    state: present
    definition: "{{ lookup('template', 'catalog-source.yml.j2') }}"

- name: Apply Operator ImageDigestMirrorSets
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig_path }}"
    state: present
    definition: "{{ lookup('template', 'idms-gitops.yml.j2') }}"

- name: Wait for a short moment to allow MCP status to start changing
  ansible.builtin.pause:
    seconds: 10
  when: machine_config_pool.watch_updates | default(true)

- name: Wait for MCP update completion
  kubernetes.core.k8s_info:
    kubeconfig: "{{ kubeconfig_path }}"
    api_version: machineconfiguration.openshift.io/v1
    kind: MachineConfigPool
    name: "{{ item }}"
  loop: "{{ machine_config_pool.pool_names }}"
  register: mcp_status
  until:
    mcp_status.resources[0].status.conditions
      | selectattr('type', 'equalto', 'Updated')
      | map(attribute='status')
      | first == 'True'
    and
    mcp_status.resources[0].status.conditions
      | selectattr('type', 'equalto', 'Updating')
      | map(attribute='status')
      | first == 'False'
    and
    mcp_status.resources[0].status.readyMachineCount
      == mcp_status.resources[0].status.machineCount
  retries: "{{ (machine_config_pool.timeout / machine_config_pool.interval) | int }}"
  delay: "{{ machine_config_pool.interval }}"
  loop_control:
    label: "{{ item }}"
  when: machine_config_pool.watch_updates | default(true) and machine_config_pool.wait_for_completion | default(true)

- name: Show final MCP state
  ansible.builtin.debug:
    msg:
      - "MCP: {{ item.resources[0].metadata.name }}"
      - "Ready: {{ item.resources[0].status.readyMachineCount }}/{{ item.resources[0].status.machineCount }}"
      - "Updated: {{ item.resources[0].status.updatedMachineCount }}"
      - "Config: {{ item.resources[0].status.configuration.name }}"
  loop: "{{ mcp_status.results | default([]) }}"
  loop_control:
    label: "{{ item.resources[0].metadata.name | default('N/A') }}"
  when: machine_config_pool.watch_updates | default(true)

- name: Get catalog source pods
  kubernetes.core.k8s_info:
    kubeconfig: "{{ kubeconfig_path }}"
    api_version: v1
    kind: Pod
    namespace: "{{ operator_marketplace_namespace }}"
    label_selectors: "{{ operator_pod_label_selectors }}"
  register: catalog_pods_info
  when: restart_operator_pods | default(false)

- name: Delete catalog source pods
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig_path }}"
    state: absent
    kind: Pod
    name: "{{ item.metadata.name }}"
    namespace: "{{ operator_marketplace_namespace }}"
  loop: "{{ catalog_pods_info.resources | default([]) }}"
  loop_control:
    label: "{{ item.metadata.name }}"
  when: restart_operator_pods | default(false)

- name: Wait for new catalog pods to appear
  kubernetes.core.k8s_info:
    kubeconfig: "{{ kubeconfig_path }}"
    api_version: v1
    kind: Pod
    namespace: "{{ operator_marketplace_namespace }}"
    label_selectors: "{{ operator_pod_label_selectors }}"
  register: new_catalog_pods
  retries: 10
  delay: 5
  until: new_catalog_pods.resources | length > 0
  when: restart_operator_pods | default(false)

- name: Wait for catalog pods to become Ready
  kubernetes.core.k8s_info:
    kubeconfig: "{{ kubeconfig_path }}"
    api_version: v1
    kind: Pod
    namespace: "{{ operator_marketplace_namespace }}"
    label_selectors: "{{ operator_pod_label_selectors }}"
    wait: true
    wait_condition:
      type: Ready
      status: "True"
    wait_timeout: "{{ operator_pod_restart_timeout }}"
  when:
    - restart_operator_pods | default(false)
    - wait_for_pod_ready | default(true)
