# ansible-role-cluster-node

A role to add a cluster node to OpenShift.

## Requirements

- `oc` installed and configured to access the OpenShift cluster.

## Role Variables

```yaml
# cpu_architecture defines the CPU architecture of the cluster nodes. It is used to determine the correct OpenShift version and image to use for the cluster nodes.
# Available architectures: amd64, arm64, ppc64le, s390x
cpu_architecture: amd64
# kubeconfig_path defines the path to the kubeconfig file used to access the OpenShift cluster. It is required to generate the ISO image if `generate_iso` is set to true.
kubeconfig_path: ""

# additional_ntp_sources is optional, if not provided, it will not be included in the agent-config.yaml
# additional_ntp_sources:
#   - "0.pool.ntp.org"
#   - "1.pool.ntp.org"

# generate_iso defines whether to generate an ISO image for the cluster nodes. If set to true, the role will generate an ISO image with the OpenShift cluster boot artifacts.
generate_iso: true
# base_dir defines the output directory for the generated ISO image. This directory is used to store the generated ISO image and its contents.
base_dir: /iso
# pull_secret is the pull secret used to access the OpenShift container images. It is required to generate the ISO image if `generate_iso` is set to true.
pull_secret: ""
# worker defines the configuration for the worker nodes in the OpenShift cluster. It is used to configure the worker nodes, including their hostnames, root devices, network interfaces, and VLANs.
worker:
  # hostname_prefix is the prefix for the worker node hostnames. It is used to generate the hostnames for the worker nodes.
  hostname_prefix: "worker-"
  # root_device_name is the name of the root device for the worker nodes. It is used to configure the root device for the worker nodes. This option only applies if `agent_config.worker.hosts[].root_device.name`, `agent_config.worker.hosts[].root_device.serial_number`, `agent_config.worker.hosts[].root_device.wwn` are not set.
  root_device_name: "/dev/sda"
  # bonds defines the bonding configuration for the worker nodes. It is used to configure the network bonding for the worker nodes.
  bonds:
    -
      # name is the name of the bond interface. It is used to configure the bond interface for the worker nodes.
      name: bond0
      # mode is the bonding mode. It is used to configure the bonding mode for the worker nodes.
      # Available modes: balance-rr, active-backup, balance-xor, broadcast, 802.3ad, balance-tlb, balance-alb
      mode: "802.3ad"
      # options defines the bonding options. It is used to configure the bonding options for the worker nodes. Any options can be set here as a key-value pair.
      options:
        miimon: "100"
        lacp_rate: "fast"
  # bridges defines the bridge configuration for the worker nodes. It is used to configure the network bridges for the worker nodes.
  bridges:
    -
      # name is the name of the bridge interface. It is used to configure the bridge interface for the worker nodes.
      name: br0
      # type is the type of the bridge interface. It is used to configure the bridge interface for the worker nodes.
      # Available types: ovs-bridge, linux-bridge
      type: ovs-bridge
      # interfaces defines the interfaces that are part of the bridge. It is used to configure the interfaces for the bridge.
      interfaces:
        -
          # name is the name of the interface that is part of the bridge. It is used to configure the interface for the bridge.
          name: bond0
  # vlans defines the VLAN configuration for the worker nodes. It is used to configure the VLANs for the worker nodes.
  vlans:
    -
      # name is the name of the VLAN interface. It is used to configure the VLAN interface for the worker nodes.
      name: vlan0
      # id is the VLAN ID. It is used to configure the VLAN ID for the worker nodes.
      id: 100
      # base_interface is the base interface for the VLAN. It is used to configure the base interface for the VLAN.
      base_interface: bond0
      # addresses defines the IP addresses for the VLAN interface. It is used to configure the IP addresses for the VLAN interface.
      addresses:
        -
          # start_ip is the starting IP address for the VLAN interface. It is used to configure the starting IP address for the VLAN interface. Each nodes VLAN IP address is generated by adding the node id to the start_ip.
          # Example:
          #    If start_ip is `192.168.10.100` and the node id is `0`, the generated IP address is `192.168.10.100`.
          #    If the node id is `3`, the generated IP address is `192.168.10.103`.
          start_ip: 192.168.255.100
          # subnet_length is the subnet length for the VLAN interface. It is used to configure the subnet length for the VLAN interface.
          # Example: If the subnet length is `24`, the generated subnet mask is `255.255.255.0`.
          subnet_length: 24
  # hosts defines all the hosts part of the cluster.
  hosts:
    # worker 0
    -
      # hostname explicitly defines the hostname of the host. If this is set, agent_config.worker.hostname_prefix is ignored. Otherwise, the hostname is generated by appending the node id to the agent_config.worker.hostname_prefix.
      # Example: If agent_config.worker.hostname_prefix is `worker-` and the node id is `0`, the generated hostname is `worker-0`.
      hostname: "worker-0"
      # root_device defines the root device RHCOS will be installed on. This is used to configure the root device for the host.
      root_device:
        # name is the name of the root device. It is used to configure the root device for the host. It is recommended to use the `/dev/disk/by-path/<device_path>` path.
        name: "/dev/sda"
        # serial_number is the serial number of the root device. It is used to identify the root device for the host.
        serial_number: "1234567890"
        # wwn is the World Wide Name (WWN) of the root device. It is used to identify the root device for the host.
        wwn: "1234567890abcdef"
      # interfaces defines a list of interfaces of the host. This list is also used to identify the host and assign the correct OpenShift cluster boot artifacts.
      interfaces:
        -
          # name is the name of the interface. It is used to configure the interface for the host.
          name: enp0s0
          # mac_address is the MAC address of the interface. It is used to identify the interface for the host.
          mac_address: "00:00:00:aa:00:00"
          # part_of_bond is the name of the bond interface that the interface is part of. It is used to configure the bond interface for the host. This setting must match the bond name defined in `agent_config.worker.bonds[].name`.
          part_of_bond: "bond0"
          # mtu (optional) is the MTU of the interface. If not set, the default MTU of the hardware will be used.
          mtu: 1500
        - name: enp0s1
          mac_address: "00:00:00:aa:00:01"
          part_of_bond: "bond0"
      vlans:
        -
          # interface is the name of the VLAN interface to which an IP address should be assigned.
          # This interface must match the name of the VLAN interface defined in `agent_config.worker.vlans[].name`.
          interface: vlan0
          # addresses defines the IP addresses for the VLAN interface. It is used to configure the IP addresses for the VLAN interface.
          # If the `agent_config.master.vlans[].addresses[].start_ip` is set, this field takes precedence over the `agent_config.worker.vlans[].addresses[].start_ip`.
          addresses:
            -
              # ip is the IPv4 or IPv6 address to assign to the VLAN interface.
              ip: 192.168.10.222
              # subnet_length is the subnet length for the VLAN interface. It is used to configure the subnet length for the VLAN interface.
              subnet_length: 24
```

## Role facts

When this role is executed, it will set the following facts automatically:

| Fact Name               | Description                                      |
|-------------------------|--------------------------------------------------|
| base_dir                | The generated base directory in which the ISO and installation configs are stored. |
| manifest_folder         | The generated directory where the agent-config.yaml and install-config.yaml files are backed up. |
| kubeconfig_path         | The generated path to the kubeconfig file. |
| kubeadmin_password_path | The generated path to the kubeadmin password file. |
| bootfile_path           | The generated path to the bootable ISO file or PXE artifacts. |
| master_node_count       | The number of master nodes defined in the agent_config. |
| worker_node_count       | The number of worker nodes defined in the agent_config. |
| total_node_count        | The total number of nodes (master + worker) defined in the agent_config. |

## Example Playbook

```yaml
- name: Add OpenShift Nodes to Cluster
  hosts: localhost
  gather_facts: false
  become: false
  vars_files:
    - ./node_config.yaml
  roles:
    - redhat_consulting_services.openshift.add_nodes
```

For a more detailed example, please refer to the `examples/cluster-setup/playbook.yaml` file in this collection.
